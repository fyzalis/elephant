$(document).ready(function(){!function(e){e.fn.elephant=function(t){function n(){h=l(localStorage.getItem("elephant"))}function i(){G(),s.active&&(s.time++,C())}function a(){1==s.favorite?(s.favorite=0,C()):(s.favorite=1,R(!0)),V()}function o(e){return JSON.stringify(e)}function l(e){return jQuery.parseJSON(e)}var r=e.extend({triggers:new Array,activeDuration:30,refreshRender:1,maxDisplayedResult:5,title:"My selection",entryName:{one:"",several:""},favoriteTrigger:"#elephant_favorite",path:"",theme:"default",lang:"en"},t),s={time:0,scroll:0,visit:0,trigger:0,favorite:0,updated_at:new Date,active:!0,score:0},c={time:1,scroll:.5,visit:30,trigger:100},d=new Array,p=!1,v=!0,h=new Array,f=localStorage.getItem("elephant_view");""!=f&&null!=f||(f="visible");var g=l(localStorage.getItem("elephant_position_has_changed"));if(null==g){var g={};g.time=new Date,g.selector="",localStorage.setItem("elephant_position_has_changed",o(g))}var u=window.location.href,m=r.path+"/themes/"+r.theme,y={page:u,text:"",image:""},_="normal",w=!1,x={},k=function(){return!!e("div#elephant").length},S=function(){return!!e("div#elephanto").length},b=function(){return null!=localStorage.getItem("elephant")},I=function(){localStorage.setItem("elephant",o(h)),localStorage.setItem("elephant_view","visible")},T=function(){return-1!==jQuery.inArray(u,h)},O=function(){if(h.length>=20)return console.error("Max recording size for elephant is limited to 20 entries. No more entry will be added before remove at least another."),!1;h.push(u),localStorage.setItem("elephant",o(h)),localStorage.setItem("elephant::"+u,o(s)),y.text=e("#elephant").data("text"),y.image=e("#elephant").data("image"),localStorage.setItem("elephanto::"+u,o(y))},A=function(){var e=l(localStorage.getItem("elephant::"+u));M(e)},D=function(e){return l(localStorage.getItem("elephant::"+e))},M=function(e){for(var t in e)e.hasOwnProperty(t)&&(s[t]="updated_at"!=t?e[t]:new Date(e[t]))},C=function(){if(w)return console.error("This entry has just been removed from list by user."),!1;Z(),localStorage.setItem("elephant::"+u,o(s))},E=function(e){w=!0;var t=0;t=h.indexOf(e),t>-1&&h.splice(t,1),localStorage.setItem("elephant",o(h)),localStorage.removeItem("elephant::"+e),localStorage.removeItem("elephanto::"+e),lastPostionList=ne(),t=lastPostionList.indexOf(e),t>-1&&lastPostionList.splice(t,1),te(),v=!0,ee(),$()},j=function(){s.visit+=1,R(!0),C()},N=function(){R(!0),s.trigger+=1,C()},R=function(e){e&&(s.updated_at=new Date),s.active=e,C()},L=function(){e.each(r.triggers,function(t,n){e(n).on("click",function(){N()})})},P=function(){e(r.favoriteTrigger).on("click",function(){v=!0,a(),C(),$()})},Q=function(){e(window).scroll(function(e){R(!0),s.scroll+=1,C()})},J=function(){e("#elephanto div.open").off(),e("#elephanto div.open").on("click",function(){_="normal",W(),Y()})},F=function(){e("#elephanto div.list div.entry div.favorite, #elephanto div.list div.entry div.image, #elephanto div.list div.entry div.text").off("click"),e("#elephanto div.list div.entry div.favorite, #elephanto div.list div.entry div.image, #elephanto div.list div.entry div.text").on("click",function(){location.href=e(this).data("url")})},U=function(){e("#elephanto div.list div.entry div.remove img").off("click"),e("#elephanto div.list div.entry div.remove img").on("click",function(){E(e(this).data("entry"))})},z=function(){e("#elephanto div.info img.info").off("click"),e("#elephanto div.info img.info").on("click",function(){e("#elephanto div.info").html(x.pluginInformation+" <span class='informations' id='infoClose'>Fermer</span>"),e("#elephanto div.info span#infoClose").off("click"),e("#elephanto div.info span#infoClose").on("click",function(){v=!0,$()})}),e("#elephanto div.info img.clear_elephant").off("click"),e("#elephanto div.info img.clear_elephant").on("click",function(){var t=" <span class='clearConfirm' id='clearOn'>"+x.yes+"</span> | <span class='clearConfirm' id='clearOff'>"+x.no+"</span>";e("#elephanto div.info").html(x.clearText+t),e("#elephanto div.info span#clearOn, #elephanto div.info span#clearOff").off("click"),e("#elephanto div.info span#clearOn").on("click",function(){e("#elephanto").css("display","none"),localStorage.clear()}),e("#elephanto div.info span#clearOff").on("click",function(){v=!0,$()})}),e("#elephanto div.info img.see_other").off("click"),e("#elephanto div.info img.see_other").on("click",function(){"normal"==_?B():"see_other"==_&&W(),$()})},G=function(){var e=new Date,t=s.updated_at.getTime()/1e3,n=e.getTime()/1e3;Math.round(n-t)>r.activeDuration&&1==s.active&&R(!1)},H=function(){var e=l(localStorage.getItem("elephant_position_has_changed"));if(""!=e.time&&""!=e.selector){var t=new Date(e.time),n=new Date(g.time);t.getTime()>n.getTime()&&(v=!0,$(),X(e.selector),g.time=e.time,g.selector="",localStorage.setItem("elephant_position_has_changed",o(g)))}},K=function(){if(e(r.favoriteTrigger).length>0){var t="",n="",i="";s.favorite?i="active":n="active",t+="<div id='elephant_favorite_off' class='"+n+"'>",t+="<span class='elephant_favorite_off'><img src='"+m+"/favorite-off.png' /></span>",t+="<span class='text'>"+x.favoriteOffText+"</span>",t+="</div>",t+="<div id='elephant_favorite_on' class='"+i+"'>",t+="<span class='elephant_favorite_on'><img src='"+m+"/favorite-on.png' /></span>",t+="<span class='text'>"+x.favoriteOnText+"</span>",t+="</div>",e("#elephant_favorite").html(t)}},V=function(){s.favorite?(e("#elephant_favorite_off").removeClass("active"),e("#elephant_favorite_on").addClass("active")):(e("#elephant_favorite_off").addClass("active"),e("#elephant_favorite_on").removeClass("active"))},Y=function(){return"visible"==f||"reduce"==f?(e("#elephanto div.open div.switch_view img.expand").css("display","none"),e("#elephanto div.open div.switch_view img.reduce").css("display","block"),e("#elephanto div.list").css("display","block"),e("#elephanto div.list div.entry:not(.hiddenEntry)").css("display","flex"),f="expand"):"expand"==f?(e("#elephanto div.open div.switch_view img.expand").css("display","block"),e("#elephanto div.open div.switch_view img.reduce").css("display","none"),e("#elephanto div.list").toggle(),f="reduce"):f="visible","expand"==f?e("div#elephanto div.info").css("display","block"):e("div#elephanto div.info").css("display","none"),localStorage.setItem("elephant_view",f),!0},$=function(){if(d.length>0&&(p||v)){var t="",n=0,i=d.length>1?r.entryName.several:r.entryName.one,a="",o="",s="",c="",h="";v=!1,p=!1,t+="<div class='open'>",t+="<div class='logo'><img src='"+m+"/logo.png' /></div>",t+="<div class='text'>"+r.title+"<span class='count'>"+d.length+i+"</span></div>",t+="<div class='switch_view'>",t+="<img class='expand' src='"+m+"/open.png' />",t+="<img class='reduce' src='"+m+"/reduce.png' />",t+="</div>",t+="</div>",t+="<div class='list'>",e.each(d,function(e,i){a=l(localStorage.getItem("elephanto::"+i)),o=l(localStorage.getItem("elephant::"+i)),s=0==n?"first":"",h=o.favorite?m+"/favorite-on.png":m+"/favorite-off.png",c=n<r.maxDisplayedResult?"":"hiddenEntry",t+="<div class='entry "+s+" "+c+"' data-score='"+o.score+"' data-position='"+n+"' data-favorite='"+o.favorite+"' data-url='"+a.page+"'>",t+="<div class='favorite' data-url='"+a.page+"'><img src='"+h+"' /></div>",a.image&&(t+="<div class='image' data-url='"+a.page+"'><img src='"+a.image+"'  /></div>"),a.text&&(t+="<div class='text' data-url='"+a.page+"'>"+a.text+"</div>"),t+="<div class='remove'><img src='"+m+"/remove.png' data-entry='"+i+"' /></div>",t+="</div>",n++}),t+="</div>",t+="<div class='info'>",n>r.maxDisplayedResult&&(t+="<span id='see_other_text'>"+x.displayModeText.normal+"</span> <img class='see_other' src='"+m+"/see.png'>"),t+="Infos <img class='info' src='"+m+"/info.png'>",t+=x.clear+" <img class='clear_elephant' src='"+m+"/clear.png' />",t+="</div>",e("#elephanto").html(t),"normal"==_?W():"see_other"==_&&B(),"expand"==f&&"see_other"==_&&e("div#elephanto div.info").css("display","block"),"expand"==f&&e("div#elephanto div.info").css("display","block"),1==d.length&&(e("div#elephanto div.open div.switch_view img.reduce").css("display","block"),e("div#elephanto div.open div.switch_view img.expand").css("display","none")),F(),J(),U(),z(),q()}0==d.length&&e("#elephanto").html("")},q=function(){f=localStorage.getItem("elephant_view"),"reduce"==f?(e("#elephanto div.list").css("display","none"),e("div#elephanto div.open div.switch_view img.reduce").css("display","none"),e("div#elephanto div.open div.switch_view img.expand").css("display","block")):"expand"==f&&(e("#elephanto div.list").css("display","block"),e("#elephanto div.list div.entry:not(.hiddenEntry)").css("display","flex"),e("div#elephanto div.open div.switch_view img.reduce").css("display","block"),e("div#elephanto div.open div.switch_view img.expand").css("display","none"))},B=function(){_="see_other",e("#see_other_text").html(x.displayModeText.see_other),e("div#elephanto").css("height",e(window).height()+"px"),e("div#elephanto div.list").css("overflow-y","auto"),e("div#elephanto div.list div.entry.hiddenEntry").css("display","flex")},W=function(){_="normal",e("#see_other_text").html(x.displayModeText.normal),e("div#elephanto").css("height","inherit"),e("div#elephanto div.list").css("overflow-y","auto"),e("div#elephanto div.list div.entry.hiddenEntry").css("display","none")},X=function(t){var n=e('div#elephanto div.entry[data-url="'+t+'"]').css("background-color");e('div#elephanto div.entry[data-url="'+t+'"]').css("background-color","#ccc"),window.setTimeout(function(){e('div#elephanto div.entry[data-url="'+t+'"]').css("transition","background-color 0.5s"),e('div#elephanto div.entry[data-url="'+t+'"]').css("background-color",n)},200)},Z=function(){var e=0;e+=Math.round(s.time*c.time),e+=Math.round(s.visit*c.visit),e+=Math.round(s.trigger*c.trigger),e+=Math.round(s.scroll*c.scroll),s.score=e,ee()},ee=function(){var t=ne(),n=(new Array,new Array),i=new Array;d=new Array;var a=0;p=!1,e.each(h,function(e,t){var a=new Array;a.page=t,a.stats=D(h[e]),a.stats.favorite?n.push(a):i.push(a)}),n.sort(function(e,t){return t.stats.score-e.stats.score}),i.sort(function(e,t){return t.stats.score-e.stats.score}),e.each(n,function(e,t){d[a]=t.page,a++}),e.each(i,function(e,t){d[a]=t.page,a++}),e.each(d,function(e,n){if(d[e]!==t[e])return p=!0,g.time=new Date,g.selector=d[e],localStorage.setItem("elephant_position_has_changed",o(g)),$(),X(d[e]),!1}),te()},te=function(){localStorage.setItem("elephant_position_list",o(d))},ne=function(){var t=l(localStorage.getItem("elephant_position_list"));return 0==e.isArray(t)&&(t=new Array),t},ie=function(){e("head").append(e("<link rel='stylesheet' href='"+r.path+"/themes/"+r.theme+"/"+r.theme+".min.css' type='text/css' media='screen' id='cssTheme' />")),document.onreadystatechange=function(){"complete"===document.readyState&&e("div#elephanto").css("display","flex")}};if(""==r.path)return console.error("You must define your Elephant directory path. Elephant not running..."),!1;!function(){e.ajax({url:r.path+"/lang/"+r.lang+".json",type:"json",type:"GET",success:function(e){x=e,ie(),ae()}})}();var ae=function(){if(k()&&(b()||I(),n(),T()||O(),A(),K(),setInterval(function(){i()},1e3),Q(),j(),L(),P()),S()){b()||I(),n(),ee(),$();setInterval(function(){n(),ee(),H()},1e3*r.refreshRender)}}},e.fn.elephantExportHTML=function(){function t(e){return jQuery.parseJSON(e)}var n=t(localStorage.getItem("elephant_position_list")),i=new Array,a=new Array,o="";return e.each(n,function(e,o){a=t(localStorage.getItem("elephant::"+o)),a.url=n[e],i.push(a)}),i.length>0&&(o+="<table border=1 cellpadding=5 style='border:solid 1px black; border-collapse: collapse;'>",o+="<caption style='font-weight:bold; text-align:left;'>User Selection Ranking</caption>",o+="<thead>",o+="<tr>",o+="<th>RANK</th>",o+="<th>TOTAL SCORE</th>",o+="<th>Favorite</th>",o+="<th>Visit</th>",o+="<th>Time</th>",o+="<th>Trigger</th>",o+="<th>Scroll</th>",o+="<th>Url</th>",o+="<th>Last update</th>",o+="</tr>",o+="</thead>",o+="<tbody>",e.each(i,function(e,t){o+="<tr>",o+="<td style='font-weight:bold;'>#"+(e+1)+"</td>",o+="<td style='font-weight:bold;'>"+t.score+"</td>",o+="<td>"+t.favorite+"</td>",o+="<td>"+t.visit+"</td>",o+="<td>"+t.time+"</td>",o+="<td>"+t.trigger+"</td>",o+="<td>"+t.scroll+"</td>",o+="<td><a href='"+t.url+"' target='_blank'>"+t.url+"</a></td>",o+="<td>"+t.updated_at+"</td>",o+="</tr>"}),o+="</tbody>",o+="</table>"),o}}(jQuery)});