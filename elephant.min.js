$(document).ready(function(){!function(e){e.fn.elephant=function(t){function i(){f=r(localStorage.getItem("elephant"))}function n(){N(),c.active&&(c.time++,I())}function a(){1==c.favorite?(c.favorite=0,I()):(c.favorite=1,E(!0)),C()}function o(e,t){t||(t="DEBUG"),console.log(t,e)}function l(e){return JSON.stringify(e)}function r(e){return jQuery.parseJSON(e)}var s=e.extend({triggers:new Array,activeDuration:30,refreshRender:1,maxDisplayedResult:5,title:"My selection",entryName:{one:"",several:""},favoriteTrigger:"#elephant_favorite",favoriteOffText:"Add to my selection",favoriteOnText:"Remove to my selection",path:"",theme:"default",displayModeText:{normal:"View all",see_other:"Reduce view"},clear:"Clear",clearText:"Would you really reset your selection ?",pluginInformation:"Selection made based on your browsing on the site."},t),c={time:0,scroll:0,visit:0,trigger:0,favorite:0,updated_at:new Date,active:!0,score:0},d={time:1,scroll:.5,visit:30,trigger:100},v=new Array,p=!1,h=!0,f=new Array,u="visible",g=window.location.pathname,m=s.path+"/themes/"+s.theme,y={page:g,text:"",image:""},_="normal",w=!1,x=function(){return null!=localStorage.getItem("elephant")},b=function(){localStorage.setItem("elephant",l(f)),localStorage.setItem("elephant_view",u)},S=function(e){return r(localStorage.getItem("elephant::"+e))},k=function(e){for(var t in e)e.hasOwnProperty(t)&&(c[t]="updated_at"!=t?e[t]:new Date(e[t]))},I=function(){if(w)return console.error("This entry has just been removed from list by user."),!1;U(),localStorage.setItem("elephant::"+g,l(c))},T=function(e){w=!0;var t=0;t=f.indexOf(e),t>-1&&f.splice(t,1),localStorage.setItem("elephant",l(f)),localStorage.removeItem("elephant::"+e),localStorage.removeItem("elephanto::"+e),lastPostionList=Y(),t=lastPostionList.indexOf(e),t>-1&&lastPostionList.splice(t,1),W(),h=!0,V(),j()},A=function(){E(!0),c.trigger+=1,I()},E=function(e){e&&(c.updated_at=new Date),c.active=e,I()},M=function(){e("#elephanto div.open").off(),e("#elephanto div.open").on("click",function(){_="normal",J(),L()})},O=function(){e("#elephanto div.list div.entry div.favorite, #elephanto div.list div.entry div.image, #elephanto div.list div.entry div.text").off("click"),e("#elephanto div.list div.entry div.favorite, #elephanto div.list div.entry div.image, #elephanto div.list div.entry div.text").on("click",function(){location.href=e(this).data("url")})},D=function(){e("#elephanto div.list div.entry div.remove img").off("click"),e("#elephanto div.list div.entry div.remove img").on("click",function(){T(e(this).data("entry"))})},R=function(){e("#elephanto div.info img.info").off("click"),e("#elephanto div.info img.info").on("click",function(){alert(s.pluginInformation)}),e("#elephanto div.info img.clear_elephant").off("click"),e("#elephanto div.info img.clear_elephant").on("click",function(){confirm(s.clearText)&&(e("#elephanto").css("display","none"),localStorage.clear())}),e("#elephanto div.info img.see_other").off("click"),e("#elephanto div.info img.see_other").on("click",function(){"normal"==_?Q():"see_other"==_&&J(),j()})},N=function(){var e=new Date,t=c.updated_at.getTime()/1e3,i=e.getTime()/1e3;Math.round(i-t)>s.activeDuration&&1==c.active&&E(!1)},C=function(){c.favorite?(e("#elephant_favorite_off").removeClass("active"),e("#elephant_favorite_on").addClass("active")):(e("#elephant_favorite_off").addClass("active"),e("#elephant_favorite_on").removeClass("active"))},L=function(){return"visible"==u||"reduce"==u?(e("#elephanto div.open div.switch_view img.expand").css("display","none"),e("#elephanto div.open div.switch_view img.reduce").css("display","block"),e("#elephanto div.list").css("display","block"),e("#elephanto div.list div.entry:not(.hiddenEntry)").css("display","flex"),e("div#elephanto div.info").css("display","block"),u="expand"):"expand"==u?(e("#elephanto div.open div.switch_view img.expand").css("display","block"),e("#elephanto div.open div.switch_view img.reduce").css("display","none"),e("#elephanto div.list").toggle(),e("div#elephanto div.info").css("display","none"),u="reduce"):u="visible",localStorage.setItem("elephant_view",u),!0},j=function(){if(v.length>0&&(p||h)){var t="",i=0,n=v.length>1?s.entryName.several:s.entryName.one,a="",l="",c="",d="",f="";h=!1,p=!1,t+="<div class='open'>",t+="<div class='logo'><img src='"+m+"/logo.png' /></div>",t+="<div class='text'>"+s.title+"<span class='count'>"+v.length+n+"</span></div>",t+="<div class='switch_view'>",t+="<img class='expand' src='"+m+"/open.png' />",t+="<img class='reduce' src='"+m+"/reduce.png' />",t+="</div>",t+="</div>",t+="<div class='list'>",e.each(v,function(e,n){a=r(localStorage.getItem("elephanto::"+n)),l=r(localStorage.getItem("elephant::"+n)),c=0==i?"first":"",f=l.favorite?m+"/favorite-on.png":m+"/favorite-off.png",d=i<s.maxDisplayedResult?"":"hiddenEntry",t+="<div class='entry "+c+" "+d+"' data-score='"+l.score+"' data-position='"+i+"' data-favorite='"+l.favorite+"' data-url='"+a.page+"'>",t+="<div class='favorite' data-url='"+a.page+"'><img src='"+f+"' /></div>",a.image&&(t+="<div class='image' data-url='"+a.page+"'><img src='"+a.image+"'  /></div>"),a.text&&(t+="<div class='text' data-url='"+a.page+"'>"+a.text+"</div>"),t+="<div class='remove'><img src='"+m+"/remove.png' data-entry='"+n+"' /></div>",t+="</div>",i++}),t+="</div>",t+="<div class='info'>",i>s.maxDisplayedResult&&(t+="<span id='see_other_text'>"+s.displayModeText.normal+"</span> <img class='see_other' src='"+m+"/see.png'>"),t+="Infos <img class='info' src='"+m+"/info.png'>",t+=s.clear+" <img class='clear_elephant' src='"+m+"/clear.png' />",t+="</div>",e("#elephanto").html(t),o(u,"VIEW STATE"),o(_,"DISPLAY MODE"),"normal"==_?J():"see_other"==_&&Q(),"expand"==u&&"see_other"==_&&e("div#elephanto div.info").css("display","block"),1==v.length&&(e("div#elephanto div.open div.switch_view img.reduce").css("display","block"),e("div#elephanto div.open div.switch_view img.expand").css("display","none")),O(),M(),D(),R(),P()}0==v.length&&e("#elephanto").html("")},P=function(){u=localStorage.getItem("elephant_view"),"reduce"==u?(e("#elephanto div.list").css("display","none"),e("div#elephanto div.open div.switch_view img.reduce").css("display","none"),e("div#elephanto div.open div.switch_view img.expand").css("display","block")):"expand"==u&&(e("#elephanto div.list").css("display","block"),e("#elephanto div.list div.entry:not(.hiddenEntry)").css("display","flex"),e("div#elephanto div.open div.switch_view img.reduce").css("display","block"),e("div#elephanto div.open div.switch_view img.expand").css("display","none"))},Q=function(){_="see_other",e("#see_other_text").html(s.displayModeText.see_other),e("div#elephanto").css("height",e(window).height()+"px"),e("div#elephanto div.list").css("overflow-y","auto"),e("div#elephanto div.list div.entry.hiddenEntry").css("display","flex")},J=function(){_="normal",e("#see_other_text").html(s.displayModeText.normal),e("div#elephanto").css("height","inherit"),e("div#elephanto div.list").css("overflow-y","auto"),e("div#elephanto div.list div.entry.hiddenEntry").css("display","none")},U=function(){var e=0;e+=Math.round(c.time*d.time),e+=Math.round(c.visit*d.visit),e+=Math.round(c.trigger*d.trigger),e+=Math.round(c.scroll*d.scroll),c.score=e,V()},V=function(){var t=Y(),i=(new Array,new Array),n=new Array;v=new Array;var a=0;p=!1,e.each(f,function(e,t){var a=new Array;a.page=t,a.stats=S(f[e]),a.stats.favorite?i.push(a):n.push(a)}),i.sort(function(e,t){return t.stats.score-e.stats.score}),n.sort(function(e,t){return t.stats.score-e.stats.score}),e.each(i,function(e,t){v[a]=t.page,a++}),e.each(n,function(e,t){v[a]=t.page,a++}),e.each(v,function(i,n){if(v[i]!==t[i]){p=!0,j();var a=e('div#elephanto div.entry[data-url="'+v[i]+'"]').css("background-color");return e('div#elephanto div.entry[data-url="'+v[i]+'"]').css("background-color","#ccc"),e('div#elephanto div.entry[data-url="'+v[i]+'"]').animate({backgroundColor:a},1e3),!1}}),W()},W=function(){localStorage.setItem("elephant_position_list",l(v))},Y=function(){var t=r(localStorage.getItem("elephant_position_list"));return 0==e.isArray(t)&&(t=new Array),t};if(""==s.path)return console.error("You must define your Elephant directory path. Elephant not running..."),!1;if(function(){return!!e("div#elephant").length}()&&(x()||b(),i(),function(){return-1!==jQuery.inArray(g,f)}()||function(){if(f.length>=20)return console.error("Max recording size for elephant is limited to 20 entries. No more entry will be added before remove at least another."),!1;f.push(g),localStorage.setItem("elephant",l(f)),localStorage.setItem("elephant::"+g,l(c)),y.text=e("#elephant").data("text"),y.image=e("#elephant").data("image"),localStorage.setItem("elephanto::"+g,l(y))}(),function(){var e=r(localStorage.getItem("elephant::"+g));k(e)}(),function(){if(e(s.favoriteTrigger).length>0){var t="",i="",n="";c.favorite?n="active":i="active",t+="<div id='elephant_favorite_off' class='"+i+"'>",t+="<span class='elephant_favorite_off'><img src='"+m+"/favorite-off.png' /></span>",t+="<span class='text'>"+s.favoriteOffText+"</span>",t+="</div>",t+="<div id='elephant_favorite_on' class='"+n+"'>",t+="<span class='elephant_favorite_on'><img src='"+m+"/favorite-on.png' /></span>",t+="<span class='text'>"+s.favoriteOnText+"</span>",t+="</div>",e("#elephant_favorite").html(t)}}(),setInterval(function(){n()},1e3),function(){e(window).scroll(function(e){E(!0),c.scroll+=1,I()})}(),function(){c.visit+=1,E(!0),I()}(),function(){e.each(s.triggers,function(t,i){e(i).on("click",function(){A()})})}(),function(){e(s.favoriteTrigger).on("click",function(){h=!0,a(),I()})}()),function(){return!!e("div#elephanto").length}()){x()||b(),function(){e("head").append(e("<link rel='stylesheet' href='"+s.path+"/themes/"+s.theme+"/"+s.theme+".min.css' type='text/css' media='screen' id='cssTheme' />")),document.onreadystatechange=function(){"complete"===document.readyState&&e("div#elephanto").css("display","flex")}}(),i(),V(),j();setInterval(function(){i(),V()},1e3*s.refreshRender)}},e.fn.elephantExportHTML=function(){function t(e){return jQuery.parseJSON(e)}var i=t(localStorage.getItem("elephant_position_list")),n=new Array,a=new Array,o="";return e.each(i,function(e,o){a=t(localStorage.getItem("elephant::"+o)),a.url=i[e],n.push(a)}),o+="<table border=1 cellpadding=5 style='border:solid 1px black; border-collapse: collapse;'>",o+="<caption style='font-weight:bold; text-align:left;'>User Selection Ranking</caption>",o+="<thead>",o+="<tr>",o+="<th>RANK</th>",o+="<th>TOTAL SCORE</th>",o+="<th>Favorite</th>",o+="<th>Visit</th>",o+="<th>Time</th>",o+="<th>Trigger</th>",o+="<th>Scroll</th>",o+="<th>Url</th>",o+="<th>Last update</th>",o+="</tr>",o+="</thead>",o+="<tbody>",e.each(n,function(e,t){o+="<tr>",o+="<td style='font-weight:bold;'>#"+(e+1)+"</td>",o+="<td style='font-weight:bold;'>"+t.score+"</td>",o+="<td>"+t.favorite+"</td>",o+="<td>"+t.visit+"</td>",o+="<td>"+t.time+"</td>",o+="<td>"+t.trigger+"</td>",o+="<td>"+t.scroll+"</td>",o+="<td><a href='"+window.location.hostname+t.url+"' target='_blank'>"+t.url+"</a></td>",o+="<td>"+t.updated_at+"</td>",o+="</tr>"}),o+="</tbody>",o+="</table>"}}(jQuery)});